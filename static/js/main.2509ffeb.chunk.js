(this["webpackJsonpshelly.lightshow"]=this["webpackJsonpshelly.lightshow"]||[]).push([[0],{113:function(e,t,n){},114:function(e,t,n){},151:function(e,t){},164:function(e,t,n){"use strict";n.r(t);var a=n(0),r=n.n(a),i=n(30),c=n.n(i),l=(n(113),n(7)),o=n(182),s=n(180),u=n(103),d=n(178),h=n(186),j=n(181),g=n(179),f=(n(114),n(9)),b=n.n(f),m=n(14),O=n(35),v=n(21),x=n(18),p=n(170),w=n(79),y=n(102),S=n(101),k=n(49),L=["shelly1","shelly2.5","shelly1PM"],C=["volumeChangedLight","avarageLight","maxLight","avarageLong"],T=new(function(e){Object(y.a)(n,e);var t=Object(S.a)(n);function n(){var e;return Object(w.a)(this,n),(e=t.call(this,"myDatabase")).lights=void 0,e.version(1).stores({lights:"++id, name, channelID, lightType, shellyType, ip"}),e}return n}(k.default)),z=n(31),E=n(80),D=n.n(E),R=(n(81),n(82),function(e,t,n){var a=n&&0!==n?"&timer=".concat(n.toString()):"";try{D.a.get("http://".concat(e.ip,"/relay/").concat(e.channelID.toString(),"?turn=").concat(t).concat(a)).then((function(e){})).catch((function(e){})).then((function(){}))}catch(r){}}),A=n(3),F={volumeChangedLight:{timeout:0,waitTime:300,threshold:0},avarageLight:{timeout:100,waitTime:300,threshold:1.2},maxLight:{timeout:1e3,waitTime:300,threshold:1.8},avarageLong:{timeout:5e3,waitTime:300,threshold:1.6}},I={},U=C.reduce((function(e,t){return Object(x.a)(Object(x.a)({},e),{},Object(v.a)({},t,!1))}),{}),M=C.reduce((function(e,t){return Object(x.a)(Object(x.a)({},e),{},Object(v.a)({},t,Date.now()))}),{}),P=C.reduce((function(e,t){return Object(x.a)(Object(x.a)({},e),{},Object(v.a)({},t,null))}),{}),W=[],B=[],q=function(e){var t=e.analyser,n=e.running,i=Object(a.useRef)(),c=Object(a.useState)(null),o=Object(l.a)(c,2),s=o[0],d=o[1],j=Object(a.useState)(0),g=Object(l.a)(j,2),f=g[0],b=g[1],m=Object(a.useRef)(),v=Object(a.useState)(null),x=Object(l.a)(v,2),w=x[0],y=x[1],S=Object(a.useState)(0),k=Object(l.a)(S,2),L=k[0],C=k[1],E=r.a.useState(),D=Object(l.a)(E,2)[1],q=r.a.useCallback((function(){return D({})}),[]),G=Object(z.useLiveQuery)((function(){return T.lights.toArray()}));Object(a.useEffect)((function(){d(i.current.getContext("2d")),y(m.current.getContext("2d"))}),[]),Object(a.useEffect)((function(){if(console.log("useEffect"),G){var e,t=Object(O.a)(G);try{for(t.s();!(e=t.n()).done;){var n=e.value;I[n.name]=!1,R(n,"off")}}catch(a){t.e(a)}finally{t.f()}}}),[G]);var N=function(e,t){var n=Date.now();if(n-M[e]>=F[e].waitTime&&U[e]!==t){if(clearTimeout(P[e]),M[e]=n,U[e]=t,G){var a,r=Object(O.a)(G);try{for(r.s();!(a=r.n()).done;){var i=a.value;i.lightType===e&&(I[i.name]=t,R(i,t?"on":"off",F[e].timeout))}}catch(c){r.e(c)}finally{r.f()}}0!==F[e].timeout&&(P[e]=setTimeout((function(){if(U[e]=!1,G){var t,n=Object(O.a)(G);try{for(n.s();!(t=n.n()).done;){var a=t.value;a.lightType===e&&(I[a.name]=!1)}}catch(c){n.e(c)}finally{n.f()}}}),F[e].timeout))}};Object(a.useEffect)((function(){if(n&&t){Object.keys(I).forEach((function(e){I[e]=!1}));var e=t.frequencyBinCount,a=new Uint8Array(e);!function(e,a){var r=i.current.width,c=i.current.height;n&&t&&(console.log(e),s.clearRect(0,0,r,c),function i(){if(n&&t){var l=requestAnimationFrame(i);b(l),t.getByteFrequencyData(a),s.fillStyle="rgb(51, 51, 51)",s.fillRect(0,0,r,c);for(var o,u=r/(e+.7),d=0,h=0;h<e;h++)o=a[h],s.fillStyle="rgb("+(o+100)+",50,50)",s.fillRect(d,c-o/2,u,o/2),d+=u+1}}())}(e,a),function(e,a){var r=m.current.width,i=m.current.height;if(n&&t){w.clearRect(0,0,r,i);var c=!0;!function l(){if(n&&t){t.getByteFrequencyData(a);var o=requestAnimationFrame(l);C(o),w.fillStyle="rgb(51, 51, 51)",w.fillRect(0,0,r,i);var s=r/10,u=W.reduce((function(e,t){return e+t}),0)/W.length,d=W.slice(W.length<-64?-1:-6),h=d.reduce((function(e,t){return e+t}),0)/d.length;w.fillStyle="rgb("+(u+100)+",200,200)",w.fillRect(1*((r+6)/5-s/2),i-u/2,s,u/2),u<h&&N("volumeChangedLight",!0),u>h&&N("volumeChangedLight",!1);var j=W.slice(W.length<-30?-1:-30),g=j.reduce((function(e,t){return e+t}),0)/j.length,f=a.reduce((function(e,t){return e+t}),0)/e*3;w.fillStyle="rgb("+(f+100)+",200,200)",w.fillRect(2*((r+6)/5-s/2),i-f/2,s,f/2),f>g*F.avarageLight.threshold&&N("avarageLight",!0),W.push(f);var b=a.reduce((function(e,t){return e<t?t:e}),0);w.fillStyle="rgb("+(b+100)+",200,200)",w.fillRect(3*((r+6)/5-s/2),i-b/2,s,b/2),b>g*F.maxLight.threshold&&N("maxLight",!0);var m=B.slice(B.length<-100?-1:-100),O=m.reduce((function(e,t){return e+t}),0)/m.length,v=a.filter((function(e){return 0!==e})).length,x=a.reduce((function(e,t){return e+t}),0)/v;w.fillStyle="rgb("+(x+100)+",200,200)",w.fillRect(4*((r+6)/5-s/2),i-x/2,s,x/2),x>O*F.avarageLong.threshold&&N("avarageLong",!0),B.push(x),c&&console.log(a),c=!1}}()}}(e,a)}else!function(){if(s){window.cancelAnimationFrame(f);var e=i.current.width,t=i.current.height;s.clearRect(0,0,e,t)}if(w){window.cancelAnimationFrame(L);var n=m.current.width,a=m.current.height;w.clearRect(0,0,n,a)}}()}),[n]);return Object(A.jsxs)(u.a,{alignSelf:"center",pad:"small",justify:"center",gap:"medium",children:[Object(A.jsxs)(u.a,{direction:"row",gap:"small",justify:"center",children:[Object(A.jsxs)(u.a,{pad:"xsmall",alignSelf:"center",border:{color:"dark-2",size:"medium"},round:"medium",elevation:"small",children:[Object(A.jsx)(u.a,{alignSelf:"center",children:"Bar"}),Object(A.jsx)("canvas",{width:"300",height:"100",ref:i}),Object(A.jsx)(u.a,{direction:"row",justify:"around",margin:"small",children:Object(A.jsx)(u.a,{children:Object(A.jsx)(p.a,{color:"brand",size:"small",opacity:"0"})})})]}),Object(A.jsxs)(u.a,{pad:"xsmall",alignSelf:"center",border:{color:"dark-2",size:"medium"},round:"medium",elevation:"small",children:[Object(A.jsx)(u.a,{alignSelf:"center",children:"Total"}),Object(A.jsx)("canvas",{width:"50",height:"100",ref:m}),Object(A.jsx)(u.a,{direction:"row",justify:"around",margin:"small",children:Object.entries(U).map((function(e){var t=Object(l.a)(e,2),n=t[0],a=t[1];return Object(A.jsx)(u.a,{children:Object(A.jsx)(p.a,{color:a?"status-warning":"status-disabled",size:"small"})},"lightTypeStatus_"+n)}))})]})]}),G&&Object(A.jsx)(u.a,{pad:"xsmall",alignSelf:"center",children:Object(A.jsx)(u.a,{direction:"row",justify:"around",margin:"small",children:Object.entries(G).map((function(e){var t=Object(l.a)(e,2),a=t[0],r=t[1];return Object(A.jsxs)(u.a,{pad:"small",margin:"small",align:"center",gap:"small",children:[Object(A.jsx)(h.a,{level:"5",margin:"none",children:r.name}),Object(A.jsx)(p.a,{color:I[r.name]?"status-warning":"status-disabled",size:"large",onClick:function(){return function(e,t){if(n)console.log("only if animation is off");else{I[e]=!t,console.log(I,e,!t),q();var a=null===G||void 0===G?void 0:G.find((function(t){return t.name==e}));a&&R(a,t?"off":"on")}}(r.name,I[r.name])}})]},"lights-".concat(a))}))})})]})},G=function(){var e=Object(a.useState)(null),t=Object(l.a)(e,2),n=t[0],r=t[1],i=Object(a.useState)(null),c=Object(l.a)(i,2),o=c[0],s=c[1],d=Object(a.useState)(null),h=Object(l.a)(d,2),g=h[0],f=h[1],O=Object(a.useState)(!1),v=Object(l.a)(O,2),x=v[0],p=v[1],w=Object(a.useState)(null),y=Object(l.a)(w,2),S=y[0],k=y[1];Object(a.useEffect)((function(){void 0===navigator.mediaDevices.getUserMedia&&(navigator.mediaDevices.getUserMedia=function(e){var t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return t?new Promise((function(n,a){t.call(navigator,e,n,a)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))});var e=new window.AudioContext||window.webkitAudioContext;r(e)}),[]);var L=function(){var e=Object(m.a)(b.a.mark((function e(){var t,a,r,i,c,l,o;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==n){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,(t=n.createAnalyser()).minDecibels=-90,t.maxDecibels=-10,t.smoothingTimeConstant=.85,t.fftSize=64,f(t),a=n.createWaveShaper(),r=n.createGain(),i=n.createBiquadFilter(),c=n.createConvolver(),e.next=15,navigator.mediaDevices.getUserMedia({audio:!0,video:!1});case 15:window.stream=l=e.sent,o=n.createMediaStreamSource(l),k(l),o.connect(a),a.connect(i),i.connect(r),c.connect(r),r.connect(t),s(o),i.gain.setTargetAtTime(0,n.currentTime,0),i.disconnect(0),i.connect(r),i.type="lowshelf",i.frequency.setTargetAtTime(1e3,n.currentTime,0),p(!0),e.next=35;break;case 32:e.prev=32,e.t0=e.catch(2),console.log("Error: Issue getting mic",e.t0);case 35:case"end":return e.stop()}}),e,null,[[2,32]])})));return function(){return e.apply(this,arguments)}}(),C=function(){var e=Object(m.a)(b.a.mark((function e(){return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,L();case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}();return Object(A.jsxs)(A.Fragment,{children:[Object(A.jsx)(u.a,{direction:"row",justify:"center",gap:"medium",margin:"small",children:x?Object(A.jsx)(j.a,{onClick:function(){p(!1),g&&(g.disconnect(0),f(null)),o&&(o.disconnect(0),s(null)),S&&(S.getAudioTracks().forEach((function(e){e.stop()})),k(null))},label:"Stop"}):Object(A.jsx)(j.a,{onClick:C,label:"Start"})}),Object(A.jsx)(q,{running:x,analyser:g})]})},N=n(185),J=n(183),Q=n(174),$=n(175),_=function(e){var t,n=e.method,r=e.toEditLight,i=e.onClose,c=Object(a.useState)(""),o=Object(l.a)(c,2),s=o[0],d=o[1],g=Object(a.useState)(""),f=Object(l.a)(g,2),O=f[0],v=f[1],x=Object(a.useState)(null),p=Object(l.a)(x,2),w=p[0],y=p[1],S=Object(a.useState)(null),k=Object(l.a)(S,2),z=k[0],E=k[1],D=Object(a.useState)(0),R=Object(l.a)(D,2),F=R[0],I=R[1],U=Object(a.useState)("Add new Light"),M=Object(l.a)(U,2),P=M[0],W=M[1];Object(a.useEffect)((function(){"edit"===n&&r&&(d(r.name),I(r.channelID),v(r.ip),y(r.shellyType),E(r.lightType),W("Edit Light"))}),[]);var B=function(){var e=Object(m.a)(b.a.mark((function e(){var t;return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(""===s||!/^(?:(?:^|\.)(?:2(?:5[0-5]|[0-4]\d)|1?\d?\d)){4}$/.test(O)||null===w||null===z){e.next=23;break}if("new"!==n){e.next=19;break}return e.prev=2,e.next=5,T.lights.add({name:s,channelID:F,lightType:z,shellyType:w,ip:O});case 5:t=e.sent,console.log("ID = "+t),d(""),v(""),I(0),y(null),E(null),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(2),console.log("Failed to add ".concat(name,": ").concat(e.t0));case 17:e.next=21;break;case 19:r&&r.id&&T.lights.put({id:r.id,name:s,channelID:F,lightType:z,shellyType:w,ip:O},r.id),i();case 21:e.next=24;break;case 23:alert("Everything is mandatory, or somthing is wrong like the IP");case 24:case"end":return e.stop()}}),e,null,[[2,14]])})));return function(){return e.apply(this,arguments)}}();return Object(A.jsxs)(u.a,{border:{color:"dark-3",size:"small"},round:"xsmall",children:[Object(A.jsx)(h.a,{level:"3",margin:"xsmall",alignSelf:"center",children:P}),Object(A.jsx)(u.a,{border:[{color:"dark-3",size:"small",side:"bottom"}]}),Object(A.jsxs)(u.a,{margin:"medium",direction:"row",gap:"small",align:"center",wrap:!0,children:[Object(A.jsxs)(u.a,{children:[Object(A.jsx)(N.a,{size:"small",placeholder:"Light Name...",value:s,plain:!0,onChange:function(e){return d(e.target.value)}}),w&&"shelly2.5"===w&&Object(A.jsx)(J.a,{size:"small",placeholder:"select ChannelID",value:null!==(t=F.toString())&&void 0!==t?t:"",options:["0","1"],onChange:function(e){var t=e.option;return I(parseInt(t))}})]}),Object(A.jsx)(u.a,{children:Object(A.jsx)(N.a,{size:"small",placeholder:"Light IP...",value:O,plain:!0,onChange:function(e){return v(e.target.value)}})}),Object(A.jsx)(J.a,{size:"small",placeholder:"select Shelly Type...",value:null!==w&&void 0!==w?w:"",options:L,onChange:function(e){var t=e.option;return y(t)}}),Object(A.jsx)(J.a,{size:"small",placeholder:"select Light Type...",value:null!==z&&void 0!==z?z:"",options:C,onChange:function(e){var t=e.option;return E(t)}}),Object(A.jsx)(u.a,{round:"full",overflow:"hidden",background:"status-ok",alignSelf:"center",children:Object(A.jsx)(j.a,{icon:"new"===n?Object(A.jsx)(Q.a,{size:"small"}):Object(A.jsx)($.a,{size:"small"}),onClick:function(){return B()},hoverIndicator:!0})})]})]})},V=n(176),H=n(177),K=function(e){var t=e.light,n=e.onEditLight,a=e.onRemoveLight;return Object(A.jsxs)(u.a,{margin:"medium",direction:"row",gap:"small",justify:"around",align:"center",children:[Object(A.jsx)(u.a,{children:Object(A.jsx)(N.a,{size:"small",value:t.name,plain:!0})}),Object(A.jsx)(u.a,{children:Object(A.jsx)(N.a,{size:"small",value:t.ip,plain:!0})}),Object(A.jsxs)(u.a,{direction:"row",gap:"small",margin:{right:"small"},children:[Object(A.jsx)(V.a,{color:"status-warning",size:"medium",onClick:function(){return n(t)}}),Object(A.jsx)(H.a,{color:"status-error",size:"medium",onClick:function(){return a(t)}})]})]})},X=function(e){var t=e.lights,n=e.onEditLight,a=e.onRemoveLight;return Object(A.jsxs)(u.a,{border:{color:"dark-3",size:"small"},round:"xsmall",children:[Object(A.jsx)(h.a,{level:"3",margin:"xsmall",alignSelf:"center",children:"Existing Lights"}),Object(A.jsx)(u.a,{border:[{color:"dark-3",size:"small",side:"bottom"}]}),t.map((function(e){return Object(A.jsx)(K,{light:e,onEditLight:n,onRemoveLight:a},"hallo_".concat(e.name))}))]})},Y=function(e){var t=e.setClose,n=Object(a.useState)(!1),r=Object(l.a)(n,2),i=r[0],c=r[1],o=Object(a.useState)(null),s=Object(l.a)(o,2),f=s[0],O=s[1],v=Object(z.useLiveQuery)((function(){return T.lights.toArray()})),x=function(){c(!1)};return Object(A.jsxs)(A.Fragment,{children:[Object(A.jsxs)(u.a,{justify:"center",alignSelf:"center",margin:"small",border:{color:"dark-3",size:"small"},round:"medium",background:"dark-1",children:[Object(A.jsxs)(d.a,{justify:"between",margin:{horizontal:"small"},height:"xxsmall",round:{corner:"top",size:"medium"},children:[Object(A.jsx)(h.a,{level:"2",margin:"none",children:"Config"}),Object(A.jsx)(u.a,{children:Object(A.jsx)(j.a,{size:"small",label:"Close",onClick:function(){return t()}})})]}),Object(A.jsx)(u.a,{border:[{color:"dark-3",size:"small",side:"bottom"}]}),Object(A.jsxs)(g.a,{alignSelf:"center",children:[!i&&Object(A.jsxs)(u.a,{pad:"small",justify:"center",gap:"large",children:[Object(A.jsx)(_,{method:"new",onClose:x}),v&&Object(A.jsx)(X,{lights:v,onEditLight:function(e){c(!0),O(e)},onRemoveLight:function(e){console.log(e),e.id&&T.lights.delete(e.id)}})]}),i&&f&&Object(A.jsx)(u.a,{pad:"small",justify:"center",gap:"large",children:Object(A.jsx)(_,{method:"edit",toEditLight:f,onClose:x})})]})]}),Object(A.jsx)("button",{className:"large-button",onClick:function(){T.transaction("rw",T.tables,Object(m.a)(b.a.mark((function e(){return b.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all(T.tables.map((function(e){return e.clear()})));case 2:case"end":return e.stop()}}),e)}))))},children:"Clear Database"})]})},Z=function(){var e=Object(a.useState)(!1),t=Object(l.a)(e,2),n=t[0],r=t[1];return Object(A.jsx)(A.Fragment,{children:Object(A.jsxs)(o.a,{theme:s.a,background:"dark-1",children:[!n&&Object(A.jsxs)(u.a,{justify:"center",alignSelf:"center",margin:"small",border:{color:"dark-3",size:"small"},round:"medium",background:"dark-1",children:[Object(A.jsxs)(d.a,{height:"xxsmall",round:{corner:"top",size:"large"},justify:"between",margin:{horizontal:"small"},children:[Object(A.jsx)(h.a,{level:"3",margin:"none",children:"Lightshow with Shellys V0.0.15"}),Object(A.jsx)(u.a,{children:Object(A.jsx)(j.a,{size:"small",label:"Settings",onClick:function(){return r(!0)}})})]}),Object(A.jsx)(u.a,{border:[{color:"dark-3",size:"small",side:"bottom"}]}),Object(A.jsx)(g.a,{alignSelf:"center",pad:"small",justify:"center",children:Object(A.jsx)(G,{})})]}),n&&Object(A.jsx)(Y,{setClose:function(){r(!1)}})]})})},ee=Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));function te(e,t){navigator.serviceWorker.register(e).then((function(e){e.onupdatefound=function(){var n=e.installing;null!=n&&(n.onstatechange=function(){"installed"===n.state&&(navigator.serviceWorker.controller?(console.log("New content is available and will be used when all tabs for this page are closed. See https://cra.link/PWA."),t&&t.onUpdate&&t.onUpdate(e)):(console.log("Content is cached for offline use."),t&&t.onSuccess&&t.onSuccess(e)))})}})).catch((function(e){console.error("Error during service worker registration:",e)}))}var ne=function(e){e&&e instanceof Function&&n.e(3).then(n.bind(null,191)).then((function(t){var n=t.getCLS,a=t.getFID,r=t.getFCP,i=t.getLCP,c=t.getTTFB;n(e),a(e),r(e),i(e),c(e)}))};c.a.render(Object(A.jsx)(r.a.StrictMode,{children:Object(A.jsx)(Z,{})}),document.getElementById("root")),function(e){if("serviceWorker"in navigator){if(new URL("/Shelly.Lightshow",window.location.href).origin!==window.location.origin)return;window.addEventListener("load",(function(){var t="".concat("/Shelly.Lightshow","/service-worker.js");ee?(!function(e,t){fetch(e,{headers:{"Service-Worker":"script"}}).then((function(n){var a=n.headers.get("content-type");404===n.status||null!=a&&-1===a.indexOf("javascript")?navigator.serviceWorker.ready.then((function(e){e.unregister().then((function(){window.location.reload()}))})):te(e,t)})).catch((function(){console.log("No internet connection found. App is running in offline mode.")}))}(t,e),navigator.serviceWorker.ready.then((function(){console.log("This web app is being served cache-first by a service worker. To learn more, visit https://cra.link/PWA")}))):te(t,e)}))}}(),ne()}},[[164,1,2]]]);
//# sourceMappingURL=main.2509ffeb.chunk.js.map